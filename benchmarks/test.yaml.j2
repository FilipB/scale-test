name: test
agents:
{% for agent in groups[hyperfoil_agent_group] %}
{%   if hyperfoil_deployer == "k8s" %}
  {{ agent }}:
    node: {{ agent }}
{%   else %}
  {{ agent }}: {{ hostvars[agent]['ansible_host'] }}:{{ hyperfoil_agent_port }}
{%   endif %}
{% endfor %}
threads: 8
http:
  host: https://app.{{ wildcard_domain }}
{% if (routers | length) > 0 %}
  addresses:
{%   for router in routers %}
  - {{ router }}
{%   endfor %}
{% endif %}
  sharedConnections: {{ test_shared_connections | default(100, true) }}
staircase:
  initialRampUpDuration: {{ test_rampup_duration }}
  steadyStateDuration: {{ test_steady_duration }}
  rampUpDuration: 5s
  initialUsersPerSec: {{ test_users_per_sec }}
  incrementUsersPerSec: {{ test_inc_users_per_sec }}
  maxIterations: {{ test_max_iterations | default(30, true) }}
  maxSessions: {{ test_users_per_sec }}
  forks:
    simple: &simple
      weight: 1
      scenario:
      - params: &params
        - randomInt:
            toVar: p
            min: 200
            max: 300
        - randomItem:
            list:
              stable: 0.8
              canary: 0.1
              mirror: 0.1
            toVar: variant
      - test:
        - httpRequest:
            GET:
              pattern: /mersennePrime?p=${p}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
            handler:
              header:
              - recordHeaderTime:
                  header: x-envoy-upstream-service-time
                  metric: simple-upstream
                  unit: ms
    proxy: &proxy
      weight: 1
      scenario:
      - params: *params
      - test:
        - httpRequest:
            GET:
              pattern: /proxy?p=${p}&url=http://app:8080/mersennePrime?p=${p}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
            handler:
              header:
              - recordHeaderTime:
                  header: x-envoy-upstream-service-time
                  metric: proxy-upstream
                  unit: ms
              - recordHeaderTime:
                  header: x-proxy-service-time
                  metric: proxy-downstream
    db: &db
      weight: 1
      scenario:
      - params: *params
      - test:
        - randomInt:
            toVar: size
            min: 5
            max: 20
        - httpRequest:
            GET:
              pattern: /db?p=${p}&host=app&size=${size}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
            handler:
               header:
               - recordHeaderTime:
                   header: x-envoy-upstream-service-time
                   metric: db-upstream
                   unit: ms
               - recordHeaderTime:
                   header: x-db-service-time
                   metric: db-downstream
