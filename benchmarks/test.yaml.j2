name: test
agents:
{% for agent in groups[hyperfoil_agent_group] %}
  {{ agent }}: {{ hostvars[agent]['ansible_host'] }}:{{ hyperfoil_agent_port }}
{% endfor %}
http:
  host: https://app.{{ wildcard_domain }}
  sharedConnections: {{ test_shared_connections | default(100, true) }}
staircase:
  initialRampUpDuration: {{ test_rampup_duration }}
  steadyStateDuration: {{ test_steady_duration }}
  rampUpDuration: 5s
  initialUsersPerSec: {{ test_users_per_sec }}
  incrementUsersPerSec: {{ test_inc_users_per_sec }}
  maxIterations: {{ test_max_iterations | default(30, true) }}
  maxUnfinishedSessions: {{ test_users_per_sec }}
  forks:
    simple: &simple
      weight: 1
      scenario:
      - params: &params
        - randomInt:
            toVar: p
            min: 200
            max: 300
        - randomItem:
            list:
              stable: 0.8
              canary: 0.1
              mirror: 0.1
            toVar: variant
      - test:
        - httpRequest:
            GET:
              pattern: /mersenneprime?p=${p}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
    proxy: &proxy
      weight: 1
      scenario:
      - params: *params
      - test:
        - httpRequest:
            GET:
              pattern: /proxy?p=${p}&url=http://app:8080/mersenneprime?p=${p}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
    db: &db
      weight: 1
      scenario:
      - params: *params
      - test:
        - randomInt:
            toVar: size
            min: 5
            max: 20
        - httpRequest:
            GET:
              pattern: /db?p=${p}&host=app&size=${size}
            headers:
              x-variant:
                fromVar: variant
            sla:
              errorRatio: 0.1
