apiVersion: v1
items:
- apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: versionbased
  spec:
    hosts:
    - "*"
    gateways:
    - app-gateway
    http:
{% for index in range(1, num_apps + 1) %}
    - match:
        uri:
          prefix: app-{{ index }}/
      route:
      - destination:
          port:
            number: 8080
          host: app
          subset: app-{{ index }}
{% endfor %}
- apiVersion: networking.istio.io/v1alpha3
  kind: DestinationRule
  metadata:
    name: app-subsets
  spec:
    host: "*"
    trafficPolicy:
      loadBalancer:
        simple: RANDOM
    subsets:
{% for index in range(1, num_apps + 1) %}
    - name: app-{{ index }}
      labels:
        deploymentconfig: app-{{ index }}
{% endfor %}
{% for index in range(1, num_apps + 1) %}
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: {{ app_label }}
    name: app-{{ index }}
  spec:
    replicas: {{ pods_per_service }}
    template:
      metadata:
        labels:
          app: {{ app_label }}
          deploymentconfig: app-{{ index }}
      spec:
        containers:
        - image: {{ docker_registry }}/{{ namespace }}/mannequin:latest
          imagePullPolicy: Always
          name: mannequin
          ports:
          - containerPort: 8080
            protocol: TCP
          readinessProbe:
            exec:
              command:
                - curl
                - localhost:8080/
              initialDelaySeconds: 5
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
    triggers:
    - type: ConfigChange
    - imageChangeParams:
        containerNames: [ mannequin ]
        from:
          kind: ImageStreamTag
          name: mannequin:latest
      type: ImageChange
{% endfor %}